name: Insights Daily Drift

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  insights-daily-drift:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: astral-sh/setup-uv@v4
        with:
          python-version: "3.12"

      # Restore Previous State
      - name: Restore Insights Daily Prev
        uses: actions/cache/restore@v4
        with:
          path: artifacts/insights.daily.prev.json
          key: insights-daily-prev-${{ github.ref_name }}-${{ github.run_id }}
          restore-keys: |
            insights-daily-prev-${{ github.ref_name }}-

      - name: Install dependencies
        run: uv sync

      # Generate Current State
      - name: Generate Daily Insights
        run: |
          mkdir -p artifacts
          uv run scripts/export_daily_insights.py

          # Hard check for artifact existence
          if [[ ! -s artifacts/insights.daily.json ]]; then
            echo "Error: artifacts/insights.daily.json missing or empty!"
            ls -la artifacts/
            exit 1
          fi

      # Rolling Diff (Current vs Prev)
      - name: Generate Rolling Diff
        run: |
          STRICT_FLAG=""
          if [[ "${{ github.event_name }}" != "pull_request" ]]; then
            STRICT_FLAG="--strict"
          fi

          uv run scripts/diff_daily_insights.py \
            --snapshot artifacts/insights.daily.json \
            --baseline artifacts/insights.daily.prev.json \
            --output artifacts/insights.daily.diff.json \
            --schema contracts/insights.daily.schema.json \
            $STRICT_FLAG

      # Upload Artifacts
      - name: Upload Daily Insights
        uses: actions/upload-artifact@v4
        with:
          name: insights.daily.json
          path: artifacts/insights.daily.json

      - name: Upload Drift Report
        uses: actions/upload-artifact@v4
        with:
          name: insights-daily-diff
          path: artifacts/insights.daily.diff.json

      # Update Prev (Cache)
      - name: Prepare Next Prev
        if: success()
        run: cp artifacts/insights.daily.json artifacts/insights.daily.prev.json

      - name: Save Insights Daily Prev
        if: success() && (github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false)
        uses: actions/cache/save@v4
        with:
          path: artifacts/insights.daily.prev.json
          key: insights-daily-prev-${{ github.ref_name }}-${{ github.run_id }}
