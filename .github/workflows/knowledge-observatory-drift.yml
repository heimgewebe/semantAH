name: Knowledge Observatory Drift

on:
  schedule:
    - cron: '25 06 * * *' # runs 10 min after publish (06:15) to verify drift
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  knowledge-observatory-drift:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - uses: astral-sh/setup-uv@v4
        with:
          python-version: "3.12"

      # Fetch Baseline from Production (Release)
      - name: Fetch Baseline (Production)
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          mkdir -p artifacts

          if gh release view knowledge-observatory --repo "$GITHUB_REPOSITORY" >/dev/null 2>&1; then
            echo "Release found. STEADY STATE: baseline is mandatory."

            DOWNLOAD_SUCCESS=0
            for i in 1 2 3; do
              if gh release download knowledge-observatory --repo "$GITHUB_REPOSITORY" \
                --pattern "knowledge.observatory.prev.json" \
                --dir "artifacts" \
                --clobber
              then
                DOWNLOAD_SUCCESS=1
                break
              fi
              echo "Attempt $i failed. Retrying in 5s..."
              sleep 5
            done

            if [[ "$DOWNLOAD_SUCCESS" -ne 1 ]] || [[ ! -s artifacts/knowledge.observatory.prev.json ]]; then
              echo "::error::Baseline artifact missing or empty although release exists."
              echo "::group::Diagnostics"
              gh --version
              gh api rate_limit --repo "$GITHUB_REPOSITORY" || true
              echo "::endgroup::"
              exit 1
            fi
          else
            echo "::notice::No 'knowledge-observatory' release found. First-run bootstrap mode."
          fi

      - name: Install dependencies
        run: uv sync

      # Generate Current State
      - name: Generate Knowledge Observatory
        run: |
          mkdir -p artifacts
          uv run scripts/observatory_mvp.py

          # Hard check for artifact existence
          if [[ ! -s artifacts/knowledge.observatory.json ]]; then
            echo "Error: artifacts/knowledge.observatory.json missing or empty!"
            ls -la artifacts/
            exit 1
          fi

      # Rolling Diff (Current vs Prev)
      - name: Generate Rolling Diff
        run: |
          STRICT_FLAG=""
          if [[ "${{ github.event_name }}" != "pull_request" ]]; then
            STRICT_FLAG="--strict"
          fi

          # Bootstrap Logic: Require baseline only if it actually exists
          STRICT_REQUIRE_BASELINE=0
          if [[ -f artifacts/knowledge.observatory.prev.json ]]; then
            STRICT_REQUIRE_BASELINE=1
          fi

          echo "STRICT_FLAG=$STRICT_FLAG STRICT_REQUIRE_BASELINE=$STRICT_REQUIRE_BASELINE"
          echo "Baseline present? $(test -f artifacts/knowledge.observatory.prev.json && echo yes || echo no)"

          STRICT_REQUIRE_BASELINE=$STRICT_REQUIRE_BASELINE \
          uv run scripts/observatory_diff.py \
            $STRICT_FLAG \
            --snapshot artifacts/knowledge.observatory.json \
            --baseline artifacts/knowledge.observatory.prev.json \
            --output artifacts/knowledge.observatory.diff.json \
            --schema contracts/knowledge.observatory.schema.json

      # Upload Artifacts
      - name: Upload Knowledge Observatory
        uses: actions/upload-artifact@v4
        with:
          name: knowledge.observatory.json
          path: artifacts/knowledge.observatory.json

      - name: Upload Drift Report
        uses: actions/upload-artifact@v4
        with:
          name: knowledge-observatory-diff
          path: artifacts/knowledge.observatory.diff.json

      # Promote Baseline (only on success and schedule)
      # This ensures 'prev' is only updated once a day (Day-over-Day drift),
      # and only when the drift check passes.
      - name: Promote Baseline (Update Release Asset)
        if: success() && github.event_name == 'schedule'
        env:
          GH_TOKEN: ${{ github.token }}
          RELEASE_TAG: knowledge-observatory
        run: |
          # Sanity check: Snapshot MUST exist for promotion
          if [[ ! -s artifacts/knowledge.observatory.json ]]; then
            echo "Error: Snapshot file missing. Cannot promote."
            exit 1
          fi

          # Sanity check: Warn if diff is missing (but allow promotion if guard passed)
          if [[ ! -s artifacts/knowledge.observatory.diff.json ]]; then
            echo "Warning: Diff file missing. Promoting anyway (Guard passed)."
          fi

          # Promote current snapshot to be the new baseline (prev)
          cp artifacts/knowledge.observatory.json artifacts/knowledge.observatory.prev.json

          # Ensure Release exists
          gh release view "$RELEASE_TAG" >/dev/null 2>&1 \
            || gh release create "$RELEASE_TAG" --title "Knowledge Observatory" --notes "Automated baseline for drift guard."

          # Upload/Overwrite the prev asset in the release
          gh release upload "$RELEASE_TAG" artifacts/knowledge.observatory.prev.json --clobber
