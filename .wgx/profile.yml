class: rust-service

tasks:
  smoke: |
    set -euo pipefail
    echo "[wgx.smoke] repo=$(basename "$(git rev-parse --show-toplevel)")"
    if [ -f Cargo.toml ]; then
      cargo metadata --no-deps > /dev/null
    fi
    if [ -f pyproject.toml ] && command -v uv >/dev/null 2>&1; then
      # leichter Python-Sanitycheck, ohne echte Tests
      uv run python -m compileall . || true
    fi

  guard: |
    set -euo pipefail

    if [ -f Cargo.toml ]; then
      cargo fmt --all -- --check
      cargo clippy --all-targets --all-features -- -D warnings
    fi

    if [ -f pyproject.toml ] && command -v uv >/dev/null 2>&1; then
      uv run ruff check .
      uv run ruff format --check .
    fi

    if command -v yamllint >/dev/null 2>&1; then
      yamllint .
    fi

  metrics: |
    if [ -x scripts/wgx-metrics-snapshot.sh ]; then
      scripts/wgx-metrics-snapshot.sh --json
    else
      echo "no metrics script; skipping"
    fi

  snapshot: ""

  knowledge: |
    set -euo pipefail
    if [ -x ./wgx/wgx ]; then
      ./wgx/wgx knowledge extract --repo . --out knowledge.graph.json
    fi
