class: python-service

tasks:
  smoke: |
    set -euo pipefail
    echo "[wgx.smoke] semantAH"
    if [ -f pyproject.toml ]; then
      uv run python -m compileall semantah || true
    fi

  guard: |
    set -euo pipefail
    if [ -f pyproject.toml ] && command -v uv >/dev/null 2>&1; then
      uv run ruff check .
      uv run ruff format --check .
    fi

  fmt: |
    set -euo pipefail
    echo "[wgx.fmt] format Python sources via ruff"
    if [ -f pyproject.toml ] && command -v uv >/dev/null 2>&1; then
      uv run ruff format .
    else
      echo "[wgx.fmt] no pyproject.toml or uv not available – skipping" >&2
      exit 0
    fi

  metrics: |
    if [ -f pyproject.toml ] && command -v uv >/dev/null 2>&1; then
      uv run pytest --cov=semantah --cov-report=xml:coverage.xml || true
    else
      echo "no metrics; skipping"
    fi

  snapshot: |
    set -euo pipefail
    echo "[wgx.snapshot] full pipeline"
    uv run pytest -q
    uv run python tools/build_index.py
    uv run python tools/build_graph.py
    uv run python tools/update_related.py

  knowledge: |
    set -euo pipefail
    echo "[wgx.knowledge] not yet implemented – skipping"
    exit 0

  semantah.index: "uv run python tools/build_index.py"
  semantah.graph: "uv run python tools/build_graph.py"
  semantah.related: "uv run python tools/update_related.py"
  semantah.all: "./wgx/wgx semantah.index && ./wgx/wgx semantah.graph && ./wgx/wgx semantah.related"
